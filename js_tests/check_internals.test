import { app } from "../../../scripts/app.js";

// TODO:
// - Execute the tests after the UI is actually loaded
// - Use a set of predefined workflows for the tests

(() => {
    function testGraphInternals() {
        const g = app.graph;
        console.assert(g, "Graph object missing");

        const serialized = g.serialize();
        console.assert(Array.isArray(serialized.nodes), "Graph serialization changed shape");

        const node = g._nodes?.[0];
        if (node) {
            console.assert('id' in node && 'type' in node, "Node structure missing expected fields");
            console.assert(serialized.nodes.some(n => n.id === node.id), "Nodeâ€“serialization mismatch");
        }
    }


    function testTabSelectors() {
        const container = document.querySelector(".workflow-tabs-container");
        console.assert(container, "Tabs container selector broke");

        const activeTab = container?.querySelector(".p-togglebutton.p-component.p-togglebutton-checked .workflow-label");
        console.assert(activeTab, "Active tab selector broke or UI changed");
    }


    function testSocketStructure() {
        const socket = app.api.socket;
        console.assert(socket instanceof WebSocket, "app.api.socket is not a WebSocket");
        console.assert(socket.url.includes("/ws"), "WebSocket URL no longer ends with /ws");
    }


    function testWidgetStructure() {
        const kritaNode = app.graph._nodes.find(n => n.type === "KritaDocument");
        if (!kritaNode) return console.warn("No KritaDocument node to test");

        const widget = kritaNode.widgets.find(w => w.label === "document");
        console.assert(widget, "Document widget not found");
        console.assert(widget.options && Array.isArray(widget.options.values), "Widget.options.values missing or not array");
    }


    function testExtensionLifecycle() {
        let fired = false;
        const testExtension = {
            name: "TestLifecycle",
            afterConfigureGraph() { fired = true; }
        };
        app.registerExtension(testExtension);
        setTimeout(() => console.assert(fired, "afterConfigureGraph never fired"), 2000);
    }


    console.group("Krita.WorkflowSync self-check");
    try {
        testGraphInternals();
        testTabSelectors();
        testSocketStructure();
        testWidgetStructure();
        testExtensionLifecycle();
        console.info("All internal assumptions hold.");
    } catch (e) {
        console.error("Self-check failed:", e);
    }
    console.groupEnd();
})();
